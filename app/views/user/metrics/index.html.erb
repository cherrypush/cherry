<% title "Metrics: #{[@project.name, @metric&.name, @selected_owners&.map(&:handle)].compact.join(' | ')}" %>

<%= render 'filters', project: @project, metric: @metric, selected_owners: @selected_owners %>

<% if @project.reports.any? %>
  <% if @project.reports.count < 2 %>
    <%= render 'backfill_instructions' %>
  <% end %>

  <% if @metric %>
    <div class="card mb-3 text-center">
      <h3 class="inline"><%= @metric.name %></h3>
      <div
        class="h-60 -mb-6"
        data-chart
        data-serie="<%= @metric.chart_data(owners: @selected_owners).sort_by(&:first).map{|x,y| {x:,y:}}.to_json %>"
        data-serie-name="<%= @metric.name %>"
        data-show-label="true"
      ></div>
    </div>

    <% if @metric.owners.none? %>
      <div class="card prose dark:prose-invert max-w-none mb-3">
        <p class="mb-3">To get a full list of occurrences:</p>
        <pre class="mt-3">npm install -g cherrypush<br><%= cherry_run_cmd(@metric.name) %></pre>
      </div>
    <% end %>

    <% if @selected_owners %>
      <div class="card prose dark:prose-invert max-w-none mb-3">
        <p class="mb-3">Use the command below to get the list of occurrences:</p>
        <pre class="mt-3">npm install -g cherrypush<br><%= cherry_run_cmd(@metric.name, @selected_owners) %></pre>
      </div>
    <% end %>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="col-4">
        <%= render 'recent_activity', metric: @metric, project: @project %>
      </div>
      <div class="col-4">
        <%= render 'top_contributors', metric: @metric %>
      </div>
      <div class="col-4">
        <%= render 'debt_owners', metric: @metric, selected_owners: @selected_owners, project: @project %>
      </div>
    </div>
  <% else %>
    <div class="grid md:grid-cols-3 gap-3">
      <% @project.metrics.each do |metric| %>
        <%= link_to user_metrics_path(
                    project_id: @project.id,
                    metric_name: metric.name,
                    owner_handles: @selected_owners&.map(&:handle),
                  ) do %>
          <div
            class="overflow-hidden text-center w-full block p-3 pb-0 bg-white border border-gray-200 rounded-lg shadow-md hover:bg-gray-100 dark:bg-gray-800 dark:border-gray-700 dark:hover:bg-gray-700"
          >
            <h3 class="inline"><%= metric.name %></h3>
            <div
              class="h-60 mt-3 -ml-9 -mr-6 -mb-12"
              data-chart
              data-serie="<%= metric.chart_data(owners: @selected_owners).sort_by(&:first).map{|x,y| {x:,y:}}.to_json %>"
              data-serie-name="<%= metric.name %>"
            ></div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
<% else %>
  <%= render 'backfill_instructions' %>
<% end %>
