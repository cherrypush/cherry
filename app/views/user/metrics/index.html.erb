<div>
  <%=
    render 'components/dropdown',
           class: 'mb-3 mr-3',
           text: "Project: #{@project.name}",
           entries: project_dropdown_entries,
           id: 'dropdown-projects'
  %>

  <% if @project.reports.any? %>
    <%=
      render 'components/dropdown',
             class: 'mb-3 mr-3',
             text: @metric ? "Metric: #{@metric.name}" : 'Filter by metric',
             entries: metric_dropdown_entries(@project, @selected_owners),
             id: 'dropdown-metrics'
    %>
  <% end %>

  <% if @selected_owners %>
    <% @selected_owners.each do |owner| %>
      <%
        remove_owner_path =
          user_metrics_path(
            project: @project,
            metric_name: @metric.name,
            owner_handles: @selected_owners.map(&:handle) - [owner.handle],
          )
      %>
      <span
        id="badge-dismiss-default"
        class="inline-flex items-center py-2.5 px-3 mr-2 text-sm font-medium text-blue-800 bg-blue-100 rounded-lg dark:bg-blue-200 dark:text-blue-800"
      >
        <%= owner.handle %>
        <a
          href="<%= remove_owner_path %>"
          type="button"
          class="inline-flex items-center p-0.5 ml-2 text-sm text-blue-400 bg-transparent rounded hover:bg-blue-200 hover:text-blue-900 dark:hover:bg-blue-300 dark:hover:text-blue-900"
          data-dismiss-target="#badge-dismiss-default"
          aria-label="Remove"
        >
          <svg
            aria-hidden="true"
            class="w-3.5 h-3.5"
            aria-hidden="true"
            fill="currentColor"
            viewBox="0 0 20 20"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <span class="sr-only">Remove badge</span>
        </a>
      </span>
    <% end %>
  <% end %>
</div>

<% if @project.reports.any? %>
  <div class="mb-3">Last updated <%= time_ago_in_words(@project.reports.last.created_at) %> ago</div>

  <% if @metric %>
    <div class="card mb-3 text-center">
      <h3 class="inline"><%= @metric.name %></h3>
      <%= area_chart @metric.chart_data(owners: @selected_owners), height: '240px' %>
    </div>
    <% if @selected_owners %>
      <div class="card prose dark:prose-invert max-w-none mb-3">
        <p class="mb-3">Use the command below to get the list of occurrences:</p>
        <pre class="mt-3">
npm install -g cherrypush
cherry run --metric="<%= @metric.name %>" --owner="<%= @selected_owners.map(&:handle).join(',') %>"</pre
        >
      </div>
    <% end %>

    <% if @metric.owners.any? %>
      <div class="overflow-x-auto relative">
        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th scope="col" class="py-3 px-6">Team</th>
              <th scope="col" class="py-3 px-6">Occurrences</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @metric.owners.each do |owner| %>
              <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
                <td class="py-4 px-6">
                  <%= owner.handle %>
                </td>
                <td class="py-4 px-6">
                  <%= owner.count %>
                </td>
                <td>
                  <% if @selected_owners && @selected_owners.map(&:handle).include?(owner.handle) %>
                    <%=
                      link_to 'Remove',
                              project_path(
                                @project,
                                metric_name: @metric.name,
                                owner_handles: @selected_owners.map(&:handle) - [owner.handle],
                              ),
                              class: 'btn-light btn-sm'
                    %>
                  <% else %>
                    <%=
                      link_to 'Add to filter',
                              user_metrics_path(
                                project: @project,
                                metric_name: @metric.name,
                                owner_handles: (@selected_owners&.map(&:handle) || []) + [owner.handle],
                              ),
                              class: 'btn-primary btn-sm'
                    %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  <% else %>
    <% @project.metrics.each do |metric| %>
      <div class="card mb-3 text-center">
        <h3 class="inline"><%= metric.name %></h3>
        <%=
          link_to 'Filter by this metric',
                  user_metrics_path(
                    project: @project,
                    metric_name: metric.name,
                    owner_handles: @selected_owners&.map(&:handle),
                  ),
                  class: 'btn-primary float-right btn-sm'
        %>
        <%= area_chart metric.chart_data(owners: @selected_owners), height: '240px' %>
      </div>
    <% end %>
  <% end %>
<% else %>
  <div class="card prose dark:prose-invert max-w-none mb-3">
    <p class="mb-3">No metrics have been tracked for this project.</p>
    <p class="mb-3">Get started with the commands below:</p>
    <pre class="mt-3">
npm install -g cherrypush
cherry init
cherry push</pre
    >
  </div>
<% end %>
