<h1>
  <%= @project.name %>
</h1>
<div class="mb-3">Updated <%= time_ago_in_words(@project.reports.last.created_at) %> ago</div>

<%=
  render 'components/dropdown',
         class: 'mb-3',
         text: 'Filter by metric',
         entries: dropdown_entries_for_metrics(@project, params[:team_name]),
         id: 'dropdown-metrics'
%>

<% if dropdown_entries_for_teams(@project, params[:metric_name]).any? %>
  <%=
    render 'components/dropdown',
           class: 'mb-3',
           text: 'Filter by team',
           entries: dropdown_entries_for_teams(@project, params[:metric_name]),
           id: 'dropdown-teams'
  %>
<% end %>

<span class="prose dark:prose-invert ml-3"><%= @occurrences.count %> occurrences</span>

<% if applied_filters? %>
  <%= link_to 'Clear filters', project_path(@project), class: 'text-link ml-3' %>
<% end %>

<% if params[:metric_name].present? %>
  <div class="card w-full mb-3">
    <%= column_chart @chart_data, stacked: true, height: '240px', legend: 'top' %>
  </div>
  <% if params[:team_name].present? %>
    <div class="overflow-x-auto relative">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="py-3 px-6">Occurrence</th>
            <th scope="col" class="py-3 px-6">Owners</th>
          </tr>
        </thead>
        <tbody>
          <% @occurrences.each do |occurrence| %>
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
              <td class="py-4 px-6">
                <div><%= link_to occurrence.permalink, occurrence.permalink, class: 'text-link' %></div>
                <pre><%= occurrence.line_content.truncate(70) %></pre>
                <span
                  class="bg-gray-100 text-gray-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-300"
                ><%= occurrence.metric_name %></span>
              </td>
              <td class="py-4 px-6">
                <%= occurrence.owners.to_sentence %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="overflow-x-auto relative">
      <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th scope="col" class="py-3 px-6">Team</th>
            <th scope="col" class="py-3 px-6">Occurrences</th>
          </tr>
        </thead>
        <tbody>
          <% dropdown_entries_for_teams(@project, params[:metric_name]).each do |entry| %>
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700">
              <td class="py-4 px-6">
                <%= entry[:title] %>
              </td>
              <td class="py-4 px-6">
                <%= @occurrences.filter { |occurrence| occurrence.owners.include?(entry[:title]) }.count %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
<% else %>
  <% dropdown_entries_for_metrics(@project, params[:team_name]).each do |entry| %>
    <div class="card mb-3 text-center">
      <h3><%= entry[:title] %></h3>
      <%=
        column_chart @chart_occurrences.where(metric_name: entry[:title]).group_by_day(:created_at).count,
                     height: '240px'
      %>
    </div>
  <% end %>
<% end %>
